{% extends 'base.html' %}

{% block title %}Trading Tool{% endblock %}

{% block content %}
<div class="glass-panel">
    <h1>Place an Order</h1>
    <form action="/place_order" method="post" id="order-form">
        <div class="autocomplete-container">
            <label for="symbol">Symbol:</label><br>
            <input type="text" id="symbol" name="symbol" autocomplete="off"><br>
        </div>

        <label for="quantity">Quantity:</label><br>
        <input type="number" id="quantity" name="quantity"><br>

        <label for="transaction_type">Transaction Type:</label><br>
        <select id="transaction_type" name="transaction_type">
            <option value="BUY">BUY</option>
            <option value="SELL">SELL</option>
        </select><br>

        <label for="product">Product:</label><br>
        <select id="product" name="product">
            <option value="MIS">MIS (Intraday)</option>
            <option value="CNC">CNC (Delivery)</option>
            <option value="NRML">NRML (Normal F&O)</option>
        </select><br>

        <label for="exchange">Exchange:</label><br>
        <select id="exchange" name="exchange">
            <option value="NSE">NSE</option>
            <option value="BSE">BSE</option>
        </select><br>

        <label for="order_type">Order Type:</label><br>
        <select id="order_type" name="order_type">
            <option value="MARKET">Market</option>
            <option value="LIMIT">Limit</option>
            <option value="SL">Stoploss (SL)</option>
            <option value="SL-M">Stoploss-Market (SL-M)</option>
        </select><br>

        <label for="price">Price (for LIMIT and SL orders):</label><br>
        <input type="number" step="0.01" id="price" name="price"><br>

        <label for="stoploss">Stoploss (%):</label><br>
        <input type="number" step="0.01" id="stoploss" name="stoploss"><br>

        <input type="submit" value="Place Order">
    </form>
</div>

<div class="glass-panel">
    <h2>Placed Orders</h2>
    <a href="/update_instruments"><button class="update-button">Update Instruments</button></a>
    <table border="1">
        <thead>
            <tr>
                <th>Order ID</th>
                <th>Symbol</th>
                <th>Quantity</th>
                <th>Price</th>
                <th>Status</th>
                <th>Initial Stoploss</th>
                <th>Current Stoploss</th>
                <th>Potential Profit Locked In (%)</th>
            </tr>
        </thead>
        <tbody>
            {% for order in orders %}
            <tr>
                <td>{{ order.order_id }}</td>
                <td>{{ order.symbol }}</td>
                <td>{{ order.quantity }}</td>
                <td>{{ order.price }}</td>
                <td>{{ order.status }}</td>
                <td>{{ order.initial_stoploss }}%</td>
                <td>{{ order.current_stoploss }}%</td>
                <td>{{ order.potential_profit }}%</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const symbolInput = document.getElementById('symbol');
    let symbols = [];
    let autocompleteList;

    // Fetch symbols from the API
    fetch('/api/symbols')
        .then(response => response.json())
        .then(data => {
            symbols = data;
        });

    symbolInput.addEventListener('input', function() {
        const value = this.value.toUpperCase();
        closeAllLists();
        if (!value) { return false; }

        autocompleteList = document.createElement('div');
        autocompleteList.setAttribute('class', 'autocomplete-items');
        this.parentNode.appendChild(autocompleteList);

        let count = 0;
        for (let i = 0; i < symbols.length && count < 10; i++) {
            if (symbols[i].toUpperCase().startsWith(value)) {
                let item = document.createElement('div');
                item.innerHTML = "<strong>" + symbols[i].substr(0, value.length) + "</strong>";
                item.innerHTML += symbols[i].substr(value.length);
                item.innerHTML += "<input type='hidden' value='" + symbols[i] + "'>";

                item.addEventListener('click', function() {
                    symbolInput.value = this.getElementsByTagName('input')[0].value;
                    closeAllLists();
                });
                autocompleteList.appendChild(item);
                count++;
            }
        }
    });

    function closeAllLists(elmnt) {
        var x = document.getElementsByClassName("autocomplete-items");
        for (var i = 0; i < x.length; i++) {
            if (elmnt != x[i] && elmnt != symbolInput) {
                x[i].parentNode.removeChild(x[i]);
            }
        }
    }

    document.addEventListener("click", function (e) {
        closeAllLists(e.target);
    });

    // Dynamic form logic
    const orderForm = document.getElementById('order-form');
    const productSelect = document.getElementById('product');
    const orderTypeSelect = document.getElementById('order_type');
    const priceInput = document.getElementById('price');

    function updateForm() {
        // Rule 1: Product vs Order Type
        if (productSelect.value === 'CNC') {
            // Disable SL and SL-M for CNC
            orderTypeSelect.querySelector('option[value="SL"]').disabled = true;
            orderTypeSelect.querySelector('option[value="SL-M"]').disabled = true;
            // If a disabled option was selected, switch to MARKET
            if (orderTypeSelect.value === 'SL' || orderTypeSelect.value === 'SL-M') {
                orderTypeSelect.value = 'MARKET';
            }
        } else {
            // Enable all for other products
            orderTypeSelect.querySelector('option[value="SL"]').disabled = false;
            orderTypeSelect.querySelector('option[value="SL-M"]').disabled = false;
        }

        // Rule 2: Order Type vs Price Field
        if (orderTypeSelect.value === 'MARKET') {
            priceInput.disabled = true;
            priceInput.value = ''; // Clear the value
        } else {
            priceInput.disabled = false;
        }
    }

    orderForm.addEventListener('change', updateForm);
    // Initial check on page load
    updateForm();
});
</script>
{% endblock %}
